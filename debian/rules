#!/usr/bin/make -f

export DH_VERBOSE = 1
export DEB_BUILD_OPTIONS = nostrip

# Rust specific
export CARGO_HOME = $(CURDIR)/debian/cargo-home

%:
	dh $@

override_dh_auto_configure:
	# Add musl target for static compilation
	rustup target add x86_64-unknown-linux-musl || true

override_dh_auto_build:
	# Build static binary with musl
	cargo build --release --target x86_64-unknown-linux-musl

override_dh_auto_install:
	# Create directories
	install -d debian/rustdesk-hbbs/usr/bin
	install -d debian/rustdesk-hbbs/lib/systemd/system
	install -d debian/rustdesk-hbbs/var/lib/rustdesk-server
	install -d debian/rustdesk-hbbs/var/log/rustdesk-server
	
	# Install binary
	install -m 755 target/x86_64-unknown-linux-musl/release/hbbs debian/rustdesk-hbbs/usr/bin/
	
	# Install systemd service
	install -m 644 systemd/rustdesk-hbbs.service debian/rustdesk-hbbs/lib/systemd/system/

override_dh_auto_test:
	# Skip tests for now

override_dh_strip:
	# Binary is already stripped during build

override_dh_auto_clean:
	cargo clean
	rm -rf $(CARGO_HOME)